# This file should go to the location /etc/nginx/sites-available/api.pageforge.xyz

# Define the upstream (load balanced) groups for each service
upstream wordsearch_puzzles_service {
    least_conn;
    server localhost:9000;
    # server localhost:9001;
    # server localhost:9002;
    # Add more puzzle instances as needed up to 9010
}

upstream tokens_service {
    least_conn;
    server localhost:8080;
    # server localhost:8081;
    # server localhost:8082;
    # Add more token instances as needed up to 8089
}

upstream usage_service {
    least_conn;
    server localhost:8090;
    # server localhost:8091;
    # server localhost:8092;
    # Add more usage instances as needed up to 8099
}

server {
    listen 80;
    server_name api.pageforge.xyz;

    # --- Puzzles Service ---
    location /api/v1/puzzles/wsearch {
        proxy_pass http://wordsearch_puzzles_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Tokens Service ---
    location /api/v1/tokens/ {
        proxy_pass http://tokens_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Usage Service ---
    location /api/v1/usage/ {
        proxy_pass http://usage_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

